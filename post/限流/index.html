<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.69.0-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>#16 限流方案 &middot; 老干妈</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://maronghe.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://maronghe.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://maronghe.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://maronghe.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://maronghe.github.io/"><h1>老干妈</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://maronghe.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>#16 限流方案</h1>
  <time datetime=2020-06-15T23:52:41&#43;0800 class="post-date">Mon, Jun 15, 2020</time>
  <blockquote>
<p>限流</p>
</blockquote>
<ol>
<li>
<p>定时清除 （1分钟一清除）</p>
<ol>
<li>实现简单</li>
<li>对于边界值，如59秒和下一秒会有问题，会得到一个请求限制速率的2倍</li>
</ol>
</li>
<li>
<p>滑动窗口（10秒一清除）</p>
<ol>
<li>是定时清除的一个优化，缩小了清除粒度但是还是有问题。</li>
</ol>
</li>
<li>
<p>漏桶算法 （桶容量 +  桶流速度） <a href="https://github.com/uber-go/ratelimit">https://github.com/uber-go/ratelimit</a></p>
<p>​	- 超过桶的容量就要涉及到排队或拒绝了</p>
<ol>
<li>不支持小流量激增</li>
</ol>
</li>
<li>
<p>令牌桶算法（定时放入桶中令牌） <a href="https://github.com/juju/ratelimit">https://github.com/juju/ratelimit</a></p>
<ol>
<li>支持小流量并发激增</li>
</ol>
</li>
</ol>
<p>分布式限流则可用于 Redis + Lua脚本实现，其原理几乎差不多。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rate.limit:&#34;</span> <span style="color:#f92672">..</span> KEYS[<span style="color:#ae81ff">1</span>] <span style="color:#75715e">--限流KEY</span>
<span style="color:#66d9ef">local</span> limit <span style="color:#f92672">=</span> tonumber(ARGV[<span style="color:#ae81ff">1</span>])        <span style="color:#75715e">--限流大小</span>
<span style="color:#66d9ef">local</span> current <span style="color:#f92672">=</span> tonumber(redis.call(<span style="color:#e6db74">&#39;get&#39;</span>, key) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;0&#34;</span>)
<span style="color:#66d9ef">if</span> current <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&gt;</span> limit <span style="color:#66d9ef">then</span> <span style="color:#75715e">--如果超出限流大小</span>
   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">else</span>  <span style="color:#75715e">--请求数+1，并设置1秒过期</span>
   redis.call(<span style="color:#e6db74">&#34;INCRBY&#34;</span>, key,<span style="color:#e6db74">&#34;1&#34;</span>)
   redis.call(<span style="color:#e6db74">&#34;expire&#34;</span>, key,<span style="color:#e6db74">&#34;1&#34;</span>)
   <span style="color:#66d9ef">return</span> current <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>再用相应的语言调用脚本。</p>
<ul>
<li>
<p>Java代码传入key和最大的限制limit参数进lua脚本</p>
</li>
<li>
<p>执行lua脚本（lua脚本判断当前key是否超过了最大限制limit）</p>
</li>
<li>
<ul>
<li>如果超过，则返回0（限流）</li>
<li>如果没超过，返回1（程序继续执行）</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考资料</p>
</blockquote>
<ul>
<li><a href="https://segmentfault.com/a/1190000016552464">https://segmentfault.com/a/1190000016552464</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247485652&amp;idx=1&amp;sn=dbcc843869bd94228cb71980cd84cc8c&amp;chksm=ebd749d5dca0c0c30c0b11c0535005a9def3c66aa3f5c56d816256122b53f367de5f5ba6a6c3&amp;token=1948873548&amp;lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247485652&amp;idx=1&amp;sn=dbcc843869bd94228cb71980cd84cc8c&amp;chksm=ebd749d5dca0c0c30c0b11c0535005a9def3c66aa3f5c56d816256122b53f367de5f5ba6a6c3&amp;token=1948873548&amp;lang=zh_CN#rd</a></li>
</ul>

</div>


    </main>

    
      
    
  </body>
</html>
